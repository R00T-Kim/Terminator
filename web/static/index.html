<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terminator Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <script src="/lib/marked.min.js"></script>
  <script>
    if (!window.marked) {
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js';
      document.head.appendChild(s);
    }
  </script>
  <script src="/lib/d3.v7.min.js"></script>
  <script>
    if (!window.d3) {
      var s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js';
      document.head.appendChild(s);
    }
  </script>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>

<header>
  <h1><span class="header-accent">&#9670;</span> TERMINATOR <span class="header-accent">&#9670;</span> DASHBOARD</h1>
  <div class="header-meta">
    <span id="last-updated">Loading...</span>
    <div class="ws-indicator">
      <div class="ws-dot" id="ws-dot"></div>
      <span id="ws-status">Disconnected</span>
    </div>
  </div>
</header>

<div class="tabs">
  <button class="tab-btn active" data-tab="ctf">CTF Sessions</button>
  <button class="tab-btn" data-tab="bounty">Bug Bounty Missions</button>
  <button class="tab-btn" data-tab="infra">Infrastructure</button>
  <button class="tab-btn" data-tab="findings">Findings</button>
  <button class="tab-btn" data-tab="graph">Attack Graph</button>
</div>

<!-- ─── CTF Tab ─────────────────────────────────────────────── -->
<div id="tab-ctf" class="tab-panel active">
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar card">
      <div class="card-title">
        <span>Sessions</span>
        <button class="refresh-btn" id="btn-refresh">Refresh</button>
      </div>
      <div class="session-list" id="session-list">
        <div class="empty-msg">Loading sessions...</div>
      </div>
    </aside>

    <!-- Right column -->
    <div>
      <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="st-sessions">-</div><div class="stat-label">Sessions</div></div>
        <div class="stat-card"><div class="stat-value" id="st-flags" style="color:#ff8080">-</div><div class="stat-label">Flags</div></div>
        <div class="stat-card"><div class="stat-value" id="st-critical" style="color:var(--critical)">-</div><div class="stat-label">Critical</div></div>
        <div class="stat-card"><div class="stat-value" id="st-high" style="color:var(--high)">-</div><div class="stat-label">High</div></div>
      </div>

      <div class="main-area">
        <div class="card">
          <div class="card-title"><span>Findings by Severity</span></div>
          <div class="findings-bars" id="findings-bars"><div class="empty-msg">Loading...</div></div>
        </div>

        <div class="card">
          <div class="card-title"><span>Service Health</span></div>
          <div class="health-grid" id="health-grid"><div class="empty-msg">Checking...</div></div>
        </div>

        <div class="card live-log-area">
          <div class="card-title">
            <span>Live Session Log</span>
            <span class="badge" id="live-session-badge">-</span>
          </div>
          <div id="log-output"></div>
        </div>
      </div>
    </div>

    <!-- Session detail (full width) -->
    <div id="session-detail" class="card" style="grid-column: 1 / 3;">
      <div class="card-title">
        <span>Session Detail: <span id="detail-session-id"></span></span>
        <button class="refresh-btn" id="btn-close-detail">Close</button>
      </div>
      <div id="detail-content"></div>
    </div>
  </div>
</div>

<!-- ─── Bug Bounty Tab ────────────────────────────────────────── -->
<div id="tab-bounty" class="tab-panel">
  <div style="max-width:1600px;margin:0 auto;padding:16px;">
    <div class="bounty-header">
      <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);">
        Active Missions — <span id="mission-count">0</span> targets
      </div>
      <button class="refresh-btn" id="btn-refresh-missions">Refresh</button>
    </div>

    <div class="mission-grid" id="mission-grid">
      <div class="empty-msg">Loading missions...</div>
    </div>

    <!-- Mission detail panel -->
    <div id="mission-detail" class="card" style="margin-top:16px;">
      <div class="card-title">
        <span>Mission: <span id="detail-mission-name"></span></span>
        <button class="refresh-btn" id="btn-close-mission">Close</button>
      </div>
      <div id="mission-detail-content"></div>
    </div>
  </div>
</div>

<!-- ─── Infrastructure Tab ───────────────────────────────────────── -->
<div id="tab-infra" class="tab-panel">
  <div style="max-width:1600px;margin:0 auto;padding:24px;">
    <div class="stats-row">
      <div class="stat-card"><div class="stat-value" id="st-targets-analyzed">-</div><div class="stat-label">Targets Analyzed</div></div>
      <div class="stat-card"><div class="stat-value" id="st-total-findings" style="color:var(--high)">-</div><div class="stat-label">Total Findings</div></div>
      <div class="stat-card"><div class="stat-value" id="st-tools-available" style="color:var(--low)">-</div><div class="stat-label">Tools Available</div></div>
      <div class="stat-card"><div class="stat-value" id="st-active-missions" style="color:var(--info)">-</div><div class="stat-label">Active Missions</div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
      <div class="card">
        <div class="card-title"><span>Security Tools</span><button class="refresh-btn" id="btn-refresh-tools">Refresh</button></div>
        <div class="health-grid" id="tools-grid"><div class="empty-msg">Loading tools...</div></div>
      </div>
      <div class="card">
        <div class="card-title"><span>Service Health</span></div>
        <div class="health-grid" id="infra-health-grid"><div class="empty-msg">Checking...</div></div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="card">
        <div class="card-title"><span>Active Agents</span><span class="badge" id="active-agent-count">0</span></div>
        <div id="active-agents-list"><div class="empty-msg">No active agents</div></div>
      </div>
      <div class="card">
        <div class="card-title"><span>Recent Agent Runs</span><button class="refresh-btn" id="btn-refresh-runs">Refresh</button></div>
        <div id="recent-runs-list" style="max-height:400px;overflow-y:auto;"><div class="empty-msg">Loading...</div></div>
      </div>
    </div>
  </div>
</div>

<!-- ─── Findings Tab ──────────────────────────────────────────────── -->
<div id="tab-findings" class="tab-panel">
  <div style="max-width:1600px;margin:0 auto;padding:24px;">
    <div class="bounty-header">
      <div style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);">
        Findings — <span id="db-findings-count">0</span> total
      </div>
      <div style="display:flex;gap:8px;">
        <select id="findings-filter-status" style="background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 12px;font-size:12px;">
          <option value="">All Status</option>
          <option value="ACTIVE">Active</option>
          <option value="SUBMITTED">Submitted</option>
          <option value="KILL">Killed</option>
          <option value="DUPLICATE">Duplicate</option>
        </select>
        <button class="refresh-btn" id="btn-refresh-findings">Refresh</button>
      </div>
    </div>
    <div id="db-findings-table" style="overflow-x:auto;">
      <table class="info-table" style="width:100%;font-size:13px;">
        <thead>
          <tr style="border-bottom:1px solid var(--border);">
            <th style="padding:10px;text-align:left;color:var(--text-dim);">ID</th>
            <th style="padding:10px;text-align:left;color:var(--text-dim);">Target</th>
            <th style="padding:10px;text-align:left;color:var(--text-dim);">Title</th>
            <th style="padding:10px;text-align:left;color:var(--text-dim);">Severity</th>
            <th style="padding:10px;text-align:left;color:var(--text-dim);">Status</th>
            <th style="padding:10px;text-align:left;color:var(--text-dim);">PoC Tier</th>
            <th style="padding:10px;text-align:left;color:var(--text-dim);">Created</th>
          </tr>
        </thead>
        <tbody id="findings-tbody"><tr><td colspan="7" class="empty-msg">Loading...</td></tr></tbody>
      </table>
    </div>

    <div class="card" style="margin-top:16px;">
      <div class="card-title"><span>Findings by Severity &amp; Status</span></div>
      <div id="findings-stats-chart" style="display:flex;gap:16px;flex-wrap:wrap;"></div>
    </div>
  </div>
</div>

<!-- ─── Attack Graph Tab ──────────────────────────────────────────── -->
<div id="tab-graph" class="tab-panel">
  <div style="max-width:1600px;margin:0 auto;padding:24px;">
    <div class="bounty-header">
      <div style="display:flex;align-items:center;gap:12px;">
        <span style="font-size:11px;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-dim);">Attack Graph</span>
        <input type="text" id="graph-target-input" placeholder="Target name..." style="background:var(--card);color:var(--text);border:1px solid var(--border);border-radius:var(--radius-sm);padding:6px 12px;font-size:13px;width:200px;">
      </div>
      <button class="refresh-btn" id="btn-load-graph">Load Graph</button>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
      <div class="card">
        <div class="card-title"><span>Attack Surface Summary</span></div>
        <div id="graph-summary"><div class="empty-msg">Enter a target and click Load Graph</div></div>
      </div>
      <div class="card">
        <div class="card-title"><span>Critical Vulnerabilities</span></div>
        <div id="graph-vulns" style="max-height:300px;overflow-y:auto;"><div class="empty-msg">-</div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title"><span>Force-Directed Graph</span></div>
      <div id="graph-viz" style="width:100%;height:500px;background:var(--bg);border-radius:var(--radius-sm);overflow:hidden;position:relative;">
        <svg id="graph-svg" width="100%" height="100%"></svg>
      </div>
    </div>
  </div>
</div>

<script>
'use strict';

// ── Safe DOM helpers ────────────────────────────────────────────────────────

function el(tag, cls, text) {
  const node = document.createElement(tag);
  if (cls) node.className = cls;
  if (text != null) node.textContent = String(text);
  return node;
}

function mdEl(content) {
  const node = document.createElement('div');
  node.className = 'md-preview';
  try { node.innerHTML = marked.parse(String(content || '')); }
  catch (e) { node.textContent = String(content || ''); }
  return node;
}

function clearEl(node) {
  while (node.firstChild) node.removeChild(node.firstChild);
}

// ── Tabs ─────────────────────────────────────────────────────────────────────

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    if (btn.dataset.tab === 'bounty') loadMissions();
    if (btn.dataset.tab === 'infra') loadInfraStats();
    if (btn.dataset.tab === 'findings') loadDBFindings();
    if (btn.dataset.tab === 'graph') { /* user clicks Load Graph button */ }
  });
});

// ── API ───────────────────────────────────────────────────────────────────────

async function apiFetch(path) {
  const r = await fetch(path);
  if (!r.ok) throw new Error('HTTP ' + r.status + ': ' + path);
  return r.json();
}

// ── Stats ─────────────────────────────────────────────────────────────────────

async function loadStats() {
  try {
    const data = await apiFetch('/api/stats');
    document.getElementById('st-sessions').textContent = data.total_sessions ?? 0;
    document.getElementById('st-flags').textContent = data.flags_captured ?? 0;
    document.getElementById('st-critical').textContent = data.findings?.critical ?? 0;
    document.getElementById('st-high').textContent = data.findings?.high ?? 0;
    document.getElementById('last-updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    renderHealth(data.health || {});
  } catch (e) {
    console.error('Stats:', e);
  }
}

// ── Sessions ──────────────────────────────────────────────────────────────────

async function loadSessions() {
  const container = document.getElementById('session-list');
  try {
    const data = await apiFetch('/api/sessions');
    const sessions = data.sessions || [];
    clearEl(container);
    if (!sessions.length) {
      container.appendChild(el('div', 'empty-msg', 'No sessions found.'));
      return;
    }
    sessions.forEach(s => container.appendChild(buildSessionItem(s)));
  } catch (e) {
    clearEl(container);
    container.appendChild(el('div', 'empty-msg', 'Error: ' + e.message));
  }
}

function buildSessionItem(s) {
  const item = el('div', 'session-item');
  item.appendChild(el('div', 'session-sid', s.session_id || '-'));
  item.appendChild(el('div', 'session-target', s.target || s.mode || 'N/A'));
  item.appendChild(el('span', 'status-badge ' + (s.status || 'unknown'), s.status || 'unknown'));
  if (s.flags && s.flags.length) {
    const note = el('span', null, ' \u25C7 ' + s.flags.length + ' flag(s)');
    note.style.cssText = 'color:var(--critical);font-size:10px;margin-left:4px;';
    item.appendChild(note);
  }
  item.addEventListener('click', () => openSession(s.session_id, item));
  return item;
}

// ── Findings ──────────────────────────────────────────────────────────────────

async function loadFindings() {
  const container = document.getElementById('findings-bars');
  try {
    const data = await apiFetch('/api/findings');
    const counts = data.counts || {};
    const max = Math.max(1, ...Object.values(counts).map(Number));
    clearEl(container);
    ['critical', 'high', 'medium', 'low', 'info'].forEach(sev => {
      const count = counts[sev] || 0;
      const pct = Math.round((count / max) * 100);

      const row = el('div', 'sev-row');

      const label = el('span', 'sev-label', sev);
      label.style.color = 'var(--' + sev + ')';
      row.appendChild(label);

      const barBg = el('div', 'sev-bar-bg');
      const bar = el('div', 'sev-bar ' + sev);
      bar.style.width = pct + '%';
      barBg.appendChild(bar);
      row.appendChild(barBg);

      row.appendChild(el('span', 'sev-count', String(count)));
      container.appendChild(row);
    });
  } catch (e) {
    clearEl(container);
    container.appendChild(el('div', 'empty-msg', 'Error: ' + e.message));
  }
}

// ── Health ────────────────────────────────────────────────────────────────────

function renderHealth(health) {
  const container = document.getElementById('health-grid');
  clearEl(container);
  const entries = Object.entries(health);
  if (!entries.length) {
    container.appendChild(el('div', 'empty-msg', 'No data'));
    return;
  }
  entries.forEach(([name, status]) => {
    const item = el('div', 'health-item');
    item.appendChild(el('div', 'health-dot ' + status));
    item.appendChild(el('span', 'health-name', name));
    container.appendChild(item);
  });
}

// ── Session detail ────────────────────────────────────────────────────────────

let activeSessionItem = null;

async function openSession(sessionId, itemEl) {
  if (activeSessionItem) activeSessionItem.classList.remove('active');
  activeSessionItem = itemEl;
  itemEl.classList.add('active');

  const detail = document.getElementById('session-detail');
  const content = document.getElementById('detail-content');
  document.getElementById('detail-session-id').textContent = sessionId;
  detail.classList.add('visible');
  clearEl(content);
  content.appendChild(el('div', 'empty-msg', 'Loading...'));

  try {
    const [session, logData] = await Promise.all([
      apiFetch('/api/sessions/' + sessionId),
      apiFetch('/api/sessions/' + sessionId + '/log?tail=200'),
    ]);

    clearEl(content);

    // Detail grid
    const grid = el('div', 'detail-grid');

    // Meta
    const metaDiv = el('div');
    metaDiv.appendChild(el('div', 'card-title', 'Info'));
    const table = document.createElement('table');
    table.className = 'info-table';
    [
      ['Status', session.status || 'unknown', true],
      ['Mode', session.mode || '-', false],
      ['Target', session.target || '-', false],
      ['Duration', session.duration_seconds ? session.duration_seconds + 's' : '-', false],
      ['Files', (session.files || []).join(', ') || '-', false],
    ].forEach(([label, value, isBadge]) => {
      const tr = document.createElement('tr');
      const tdLabel = el('td', null, label);
      const tdVal = document.createElement('td');
      if (isBadge) {
        tdVal.appendChild(el('span', 'status-badge ' + (session.status || 'unknown'), value));
      } else {
        tdVal.textContent = value;
      }
      tr.appendChild(tdLabel);
      tr.appendChild(tdVal);
      table.appendChild(tr);
    });
    metaDiv.appendChild(table);
    grid.appendChild(metaDiv);

    // Flags
    const flagsDiv = el('div');
    const flags = session.flags || [];
    flagsDiv.appendChild(el('div', 'card-title', 'Flags (' + flags.length + ')'));
    if (flags.length) {
      const list = el('div', 'flags-list');
      flags.forEach(f => list.appendChild(el('div', 'flag-item', f)));
      flagsDiv.appendChild(list);
    } else {
      flagsDiv.appendChild(el('div', 'empty-msg', 'No flags'));
    }
    grid.appendChild(flagsDiv);
    content.appendChild(grid);

    // Log
    const lines = logData.lines || [];
    if (lines.length) {
      content.appendChild(el('div', 'card-title mt8', 'Session Log (last ' + lines.length + ' lines)'));
      const logEl = el('div', 'detail-log');
      logEl.textContent = lines.join('\n');
      content.appendChild(logEl);
    }

    // Writeup
    if (session.writeup) {
      content.appendChild(el('div', 'card-title mt8', 'Writeup Preview'));
      const wpEl = el('div', 'detail-log');
      wpEl.style.color = 'var(--text)';
      wpEl.textContent = session.writeup;
      content.appendChild(wpEl);
    }

  } catch (e) {
    clearEl(content);
    content.appendChild(el('div', 'empty-msg', 'Error: ' + e.message));
  }
}

function closeDetail() {
  document.getElementById('session-detail').classList.remove('visible');
  if (activeSessionItem) { activeSessionItem.classList.remove('active'); activeSessionItem = null; }
}

// ── Bug Bounty Missions ────────────────────────────────────────────────────────

let activeMissionCard = null;

async function loadMissions() {
  const grid = document.getElementById('mission-grid');
  clearEl(grid);
  grid.appendChild(el('div', 'empty-msg', 'Loading missions...'));
  try {
    const data = await apiFetch('/api/bounty/missions');
    const missions = data.missions || [];
    document.getElementById('mission-count').textContent = missions.length;
    clearEl(grid);
    if (!missions.length) {
      grid.appendChild(el('div', 'empty-msg', 'No missions found in targets/ directory.'));
      return;
    }
    missions.forEach(m => grid.appendChild(buildMissionCard(m)));
  } catch (e) {
    clearEl(grid);
    grid.appendChild(el('div', 'empty-msg', 'Error: ' + e.message));
  }
}

function buildMissionCard(m) {
  const card = el('div', 'mission-card');

  // Name
  card.appendChild(el('div', 'mission-name', m.name));

  // Meta row: status badge, score, findings
  const meta = el('div', 'mission-meta');
  const statusCls = 'go-badge ' + (m.status || 'UNKNOWN');
  const statusLabel = (m.status || 'UNKNOWN').replace(/_/g, ' ');
  meta.appendChild(el('span', statusCls, statusLabel));
  if (m.score !== null && m.score !== undefined) {
    meta.appendChild(el('span', 'score-badge', 'Score: ' + m.score + '/10'));
  }
  if (m.findings_count > 0) {
    meta.appendChild(el('span', 'findings-badge', m.findings_count + ' finding(s)'));
  }
  card.appendChild(meta);

  // Phase label
  card.appendChild(el('div', 'pipeline-label', m.current_phase));

  // Pipeline progress bar
  const barEl = el('div', 'pipeline-bar');
  const total = m.phases_total || 8;
  const done = m.phases_complete || 0;
  for (let i = 0; i < total; i++) {
    const dot = el('div', 'phase-dot');
    if (i < done) dot.classList.add('done');
    else if (i === done) dot.classList.add('current');
    barEl.appendChild(dot);
  }
  card.appendChild(barEl);

  card.addEventListener('click', () => openMission(m.name, card));
  return card;
}

async function openMission(name, cardEl) {
  if (activeMissionCard) activeMissionCard.classList.remove('active');
  activeMissionCard = cardEl;
  cardEl.classList.add('active');

  const detail = document.getElementById('mission-detail');
  const content = document.getElementById('mission-detail-content');
  document.getElementById('detail-mission-name').textContent = name;
  detail.classList.add('visible');
  clearEl(content);
  content.appendChild(el('div', 'empty-msg', 'Loading mission data...'));

  try {
    const [mission, pipeline] = await Promise.all([
      apiFetch('/api/bounty/missions/' + encodeURIComponent(name)),
      apiFetch('/api/bounty/missions/' + encodeURIComponent(name) + '/pipeline'),
    ]);

    clearEl(content);

    // Mission tabs
    const tabBar = el('div', 'mission-tabs');
    const tabs = [
      { key: 'pipeline', label: 'Pipeline' },
      { key: 'assessment', label: 'Assessment' },
      { key: 'findings', label: 'Findings' },
      { key: 'exploits', label: 'Exploits' },
      { key: 'reports', label: 'Reports' },
      { key: 'reviews', label: 'Reviews' },
    ];
    const panels = {};

    tabs.forEach((t, idx) => {
      const btn = el('button', 'mission-tab' + (idx === 0 ? ' active' : ''), t.label);
      const panel = el('div', 'mission-tab-panel' + (idx === 0 ? ' active' : ''));
      panels[t.key] = panel;
      btn.addEventListener('click', () => {
        tabBar.querySelectorAll('.mission-tab').forEach(b => b.classList.remove('active'));
        content.querySelectorAll('.mission-tab-panel').forEach(p => p.classList.remove('active'));
        btn.classList.add('active');
        panel.classList.add('active');
      });
      tabBar.appendChild(btn);
      return panel;
    });
    content.appendChild(tabBar);

    // Pipeline tab
    const timeline = el('div', 'pipeline-timeline');
    (pipeline.phases || []).forEach(ph => {
      const row = el('div', 'phase-row');
      const icon = el('div', 'phase-icon ' + (ph.complete ? 'done' : 'pending'), ph.complete ? '\u2713' : '\u00B7');
      row.appendChild(icon);
      row.appendChild(el('span', 'phase-label', ph.label));
      const artSpan = el('span', 'phase-artifact', ph.artifact);
      row.appendChild(artSpan);
      timeline.appendChild(row);
    });
    panels['pipeline'].appendChild(timeline);
    if (pipeline.current_phase) {
      const cur = el('div', null, 'Current: ' + pipeline.current_phase);
      cur.style.cssText = 'font-size:11px;color:var(--info);margin-top:10px;';
      panels['pipeline'].appendChild(cur);
    }

    // Assessment tab
    if (mission.assessment) {
      panels['assessment'].appendChild(mdEl(mission.assessment));
    } else {
      panels['assessment'].appendChild(el('div', 'empty-msg', 'No target_assessment.md found.'));
    }

    // Findings tab
    if (mission.vulnerability_candidates) {
      panels['findings'].appendChild(mdEl(mission.vulnerability_candidates));
    } else {
      panels['findings'].appendChild(el('div', 'empty-msg', 'No vulnerability_candidates.md found.'));
    }

    // Exploits tab
    if (mission.exploit_results) {
      panels['exploits'].appendChild(mdEl(mission.exploit_results));
    } else {
      panels['exploits'].appendChild(el('div', 'empty-msg', 'No exploit_results.md found.'));
    }

    // Reports tab
    const drafts = mission.report_drafts || [];
    if (drafts.length) {
      drafts.forEach(d => {
        const wrapper = el('div', 'report-draft');
        wrapper.appendChild(el('div', 'report-draft-name', d.filename));
        wrapper.appendChild(mdEl(d.content));
        panels['reports'].appendChild(wrapper);
      });
    } else {
      panels['reports'].appendChild(el('div', 'empty-msg', 'No report drafts found in immunefi_reports/.'));
    }

    // Reviews tab
    let hasReview = false;
    if (mission.critic_review) {
      panels['reviews'].appendChild(el('div', 'report-draft-name', 'critic_review.md'));
      panels['reviews'].appendChild(mdEl(mission.critic_review));
      hasReview = true;
    }
    if (mission.architect_review) {
      panels['reviews'].appendChild(el('div', 'report-draft-name', 'architect_review.md'));
      panels['reviews'].appendChild(mdEl(mission.architect_review));
      hasReview = true;
    }
    if (!hasReview) {
      panels['reviews'].appendChild(el('div', 'empty-msg', 'No review files found.'));
    }

    // Attach panels to content
    tabs.forEach(t => content.appendChild(panels[t.key]));

  } catch (e) {
    clearEl(content);
    content.appendChild(el('div', 'empty-msg', 'Error: ' + e.message));
  }
}

function closeMissionDetail() {
  document.getElementById('mission-detail').classList.remove('visible');
  if (activeMissionCard) { activeMissionCard.classList.remove('active'); activeMissionCard = null; }
}

// ── WebSocket live log ─────────────────────────────────────────────────────────

let ws = null;
const MAX_LOG_LINES = 500;
let logLineCount = 0;

function appendLogLine(text, extraCls) {
  const logEl = document.getElementById('log-output');
  const span = el('span', 'log-line' + (extraCls ? ' ' + extraCls : ''), text);
  logEl.appendChild(span);
  logEl.appendChild(document.createTextNode('\n'));
  logLineCount++;
  // Trim oldest lines
  while (logLineCount > MAX_LOG_LINES && logEl.firstChild) {
    logEl.removeChild(logEl.firstChild);
    if (logEl.firstChild && logEl.firstChild.nodeType === 3) logEl.removeChild(logEl.firstChild);
    logLineCount--;
  }
  logEl.scrollTop = logEl.scrollHeight;
}

function connectWebSocket() {
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(proto + '://' + location.host + '/ws/live');
  const dot = document.getElementById('ws-dot');
  const label = document.getElementById('ws-status');

  ws.onopen = () => {
    dot.classList.add('connected');
    label.textContent = 'Live';
    const logEl = document.getElementById('log-output');
    clearEl(logEl);
    logLineCount = 0;
  };

  ws.onmessage = (evt) => {
    try {
      const msg = JSON.parse(evt.data);
      if (msg.type === 'log') {
        document.getElementById('live-session-badge').textContent = msg.session || '-';
        (msg.data || '').split('\n').filter(Boolean).forEach(line => {
          const cls = /error|fail|FAIL|Error/i.test(line) ? 'err'
                    : /warn|WARN/i.test(line) ? 'warn' : '';
          appendLogLine(line, cls);
        });
      } else if (msg.type === 'idle') {
        const logEl = document.getElementById('log-output');
        clearEl(logEl);
        logLineCount = 0;
        const span = el('span', 'log-idle', '[' + (msg.ts || '') + '] ' + (msg.message || ''));
        logEl.appendChild(span);
      } else if (msg.type === 'error') {
        appendLogLine('WS Error: ' + (msg.message || ''), 'err');
      }
    } catch (e) { console.error('WS parse:', e); }
  };

  ws.onclose = () => {
    dot.classList.remove('connected');
    label.textContent = 'Disconnected';
    setTimeout(connectWebSocket, 5000);
  };
  ws.onerror = () => ws.close();
}

// ── Infrastructure Tab ──────────────────────────────────────────────────────

async function loadInfraStats() {
  try {
    const [statsData, toolsData, runsData] = await Promise.all([
      apiFetch('/api/stats').catch(() => ({})),
      apiFetch('/api/tools').catch(() => ({tools: {}, total_available: 0, total: 0})),
      apiFetch('/api/agent-runs?limit=20').catch(() => ({runs: []})),
    ]);

    // Update stat cards
    document.getElementById('st-targets-analyzed').textContent = statsData.total_missions ?? 0;
    document.getElementById('st-total-findings').textContent = statsData.total_findings ?? 0;
    document.getElementById('st-tools-available').textContent = (toolsData.total_available ?? 0) + '/' + (toolsData.total ?? 0);
    document.getElementById('st-active-missions').textContent = statsData.active_missions ?? 0;

    // Render tools grid
    const toolsGrid = document.getElementById('tools-grid');
    clearEl(toolsGrid);
    const tools = toolsData.tools || {};
    const toolEntries = Object.entries(tools);
    if (!toolEntries.length) {
      toolsGrid.appendChild(el('div','empty-msg','No tools data'));
    } else {
      toolEntries.forEach(([name, info]) => {
        const item = el('div','health-item');
        item.appendChild(el('div','health-dot ' + (info.available ? 'up' : 'down')));
        const label = el('span','health-name', name);
        if (info.available) label.style.color = 'var(--text)';
        item.appendChild(label);
        toolsGrid.appendChild(item);
      });
    }

    // Render health grid
    const healthGrid = document.getElementById('infra-health-grid');
    clearEl(healthGrid);
    const health = statsData.health || {};
    const healthEntries = Object.entries(health);
    if (!healthEntries.length) {
      healthGrid.appendChild(el('div','empty-msg','No health data'));
    } else {
      healthEntries.forEach(([name, status]) => {
        const item = el('div','health-item');
        item.appendChild(el('div','health-dot ' + status));
        item.appendChild(el('span','health-name', name));
        healthGrid.appendChild(item);
      });
    }

    renderRecentRuns(runsData.runs || []);
  } catch(e) { console.error('Infra stats:', e); }

  try {
    const active = await apiFetch('/api/agent-runs/active').catch(() => ({active: []}));
    const list = document.getElementById('active-agents-list');
    const agents = active.active || [];
    document.getElementById('active-agent-count').textContent = agents.length;
    clearEl(list);
    if (!agents.length) { list.appendChild(el('div','empty-msg','No active agents')); return; }
    agents.forEach(a => {
      const item = el('div','session-item');
      item.appendChild(el('div','session-target', a.agent_role + ' \u2192 ' + (a.target||'-')));
      item.appendChild(el('span','status-badge running', a.model || 'unknown'));
      list.appendChild(item);
    });
  } catch(e) { console.error('Active agents:', e); }
}

function renderRecentRuns(runs) {
  const list = document.getElementById('recent-runs-list');
  clearEl(list);
  if (!runs.length) { list.appendChild(el('div','empty-msg','No agent runs recorded')); return; }
  runs.forEach(r => {
    const item = el('div','session-item');
    const role = el('div','session-target', r.agent_role || '-');
    item.appendChild(role);
    const meta = el('div','session-sid', (r.target||'-') + ' | ' + (r.model||'-') + ' | ' + (r.duration_seconds ? r.duration_seconds+'s' : '-'));
    item.appendChild(meta);
    const statusCls = r.status === 'COMPLETED' ? 'completed' : r.status === 'RUNNING' ? 'running' : 'failed';
    item.appendChild(el('span','status-badge '+statusCls, r.status || 'unknown'));
    list.appendChild(item);
  });
}

// ── Findings Tab ──────────────────────────────────────────────────────────

async function loadDBFindings() {
  const tbody = document.getElementById('findings-tbody');
  const statusFilter = document.getElementById('findings-filter-status').value;
  clearEl(tbody);
  try {
    const url = '/api/db/findings' + (statusFilter ? '?status=' + statusFilter : '');
    const data = await apiFetch(url);
    const findings = data.findings || [];
    document.getElementById('db-findings-count').textContent = data.total ?? findings.length;
    if (!findings.length) {
      const tr = document.createElement('tr');
      const td = el('td','empty-msg','No findings found. Analyze some targets first.');
      td.colSpan = 7;
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }
    findings.forEach((f, idx) => {
      const tr = document.createElement('tr');
      tr.style.borderBottom = '1px solid var(--border-subtle)';
      const sevColor = {'critical':'var(--critical)','high':'var(--high)','medium':'var(--medium)','low':'var(--low)'}[(f.severity||'').toLowerCase()] || 'var(--text-dim)';
      const displayId = f.id != null ? String(f.id).substring(0,20) : String(idx+1);
      const displayDate = f.created_at ? new Date(f.created_at).toLocaleDateString()
                        : f.file ? f.file.split('/')[0] : '-';
      const displayStatus = f.status || (f.source === 'filesystem' ? 'FS' : '-');
      const displayTier = f.poc_tier ? 'Tier '+f.poc_tier
                        : f.cvss_score ? 'CVSS '+f.cvss_score : '-';
      [
        displayId, f.target||'-', (f.title||'-').substring(0,60),
        f.severity||'-', displayStatus, displayTier, displayDate
      ].forEach((val, i) => {
        const td = el('td', null, String(val));
        td.style.padding = '8px 10px';
        if (i === 3) td.style.color = sevColor;
        if (i === 4) {
          const statusColors = {'ACTIVE':'var(--info)','SUBMITTED':'var(--low)','KILL':'var(--critical)','DUPLICATE':'var(--text-dim)','FS':'var(--accent)'};
          td.style.color = statusColors[displayStatus] || 'var(--text)';
          td.style.fontWeight = '600';
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
  } catch(e) {
    const tr = document.createElement('tr');
    const td = el('td','empty-msg','Error: '+e.message);
    td.colSpan = 7;
    tr.appendChild(td);
    tbody.appendChild(tr);
  }

  // Stats chart
  try {
    const stats = await apiFetch('/api/db/findings/stats');
    const chart = document.getElementById('findings-stats-chart');
    clearEl(chart);
    (stats.stats || []).forEach(s => {
      const card = el('div','stat-card');
      card.style.minWidth = '120px';
      const sevColor = {'critical':'var(--critical)','high':'var(--high)','medium':'var(--medium)','low':'var(--low)'}[(s.severity||'').toLowerCase()] || 'var(--text-dim)';
      const val = el('div','stat-value', String(s.count));
      val.style.color = sevColor;
      val.style.fontSize = '24px';
      card.appendChild(val);
      card.appendChild(el('div','stat-label', (s.target||'?')+' / '+(s.severity||'?')));
      chart.appendChild(card);
    });
  } catch(e) { /* ignore stats error */ }
}

// ── Attack Graph Tab ──────────────────────────────────────────────────────

async function loadGraphData() {
  const target = document.getElementById('graph-target-input').value.trim();
  if (!target) { alert('Enter a target name'); return; }

  // Summary
  const summaryEl = document.getElementById('graph-summary');
  clearEl(summaryEl);
  try {
    const summary = await apiFetch('/api/graph/summary?target=' + encodeURIComponent(target));
    const data = (summary && summary[0]) || summary || {};
    const table = document.createElement('table');
    table.className = 'info-table';
    [['Hosts', data.hosts],['Services', data.services],['Endpoints', data.endpoints],
     ['Vulnerabilities', data.vulnerabilities],['Findings', data.findings]].forEach(([k,v]) => {
      const tr = document.createElement('tr');
      tr.appendChild(el('td',null,k));
      const td = el('td',null,String(v ?? 0));
      td.style.fontWeight = '600';
      td.style.color = '#fff';
      tr.appendChild(td);
      table.appendChild(tr);
    });
    summaryEl.appendChild(table);
  } catch(e) { summaryEl.appendChild(el('div','empty-msg','Error: '+e.message)); }

  // Critical vulns
  const vulnsEl = document.getElementById('graph-vulns');
  clearEl(vulnsEl);
  try {
    const vulns = await apiFetch('/api/graph/critical-vulns?target=' + encodeURIComponent(target));
    const items = Array.isArray(vulns) ? vulns : [];
    if (!items.length) { vulnsEl.appendChild(el('div','empty-msg','No critical vulns (CVSS >= 7.0)')); }
    else items.forEach(v => {
      const item = el('div','session-item');
      const cveId = v['v.cve_id'] || v.cve_id || v.description || '-';
      item.appendChild(el('div','session-target', cveId));
      const desc = (v['v.description'] || v.description || '-').substring(0,80);
      const cvssLabel = v.cvss ? ' (CVSS: ' + v.cvss + ')' : '';
      item.appendChild(el('div','session-sid', desc + cvssLabel));
      const sev = v['v.severity'] || v.severity || '';
      const sevCls = sev === 'CRITICAL' || sev === 'critical' ? 'failed' : 'unknown';
      item.appendChild(el('span','status-badge '+sevCls, sev));
      vulnsEl.appendChild(item);
    });
  } catch(e) { vulnsEl.appendChild(el('div','empty-msg','Error: '+e.message)); }

  // D3 Graph Visualization
  try {
    const graphData = await apiFetch('/api/graph/export?target=' + encodeURIComponent(target));
    renderD3Graph(graphData);
  } catch(e) { console.error('Graph viz:', e); }
}

function renderD3Graph(data) {
  const svg = d3.select('#graph-svg');
  svg.selectAll('*').remove();
  const container = document.getElementById('graph-viz');
  const width = container.clientWidth || 800;
  const height = container.clientHeight || 500;

  // Build nodes and links — support both Neo4j format and filesystem format
  const nodes = [];
  const links = [];
  const nodeMap = {};

  function addNode(id, label, type) {
    if (!nodeMap[id]) {
      nodeMap[id] = {id, label: label||id, type};
      nodes.push(nodeMap[id]);
    }
    return nodeMap[id];
  }

  // If data has pre-built nodes/links (filesystem format), use directly
  if (data.nodes && Array.isArray(data.nodes)) {
    data.nodes.forEach(n => addNode(n.id, n.label, n.type));
    (data.links || []).forEach(l => {
      links.push({source: l.source, target: l.target});
    });
  } else {
    // Neo4j export format (legacy)
    addNode('target:'+data.target, data.target, 'target');

    (data.critical_vulnerabilities || []).forEach(v => {
      const cve = v['v.cve_id'] || v.cve_id || 'unknown';
      addNode('vuln:'+cve, cve, 'vulnerability');
      links.push({source: 'target:'+data.target, target: 'vuln:'+cve});
    });

    (data.exploitable_services || []).forEach(s => {
      const svcName = (s['s.name']||s.name||'svc') + ':' + (s['s.port']||s.port||'?');
      addNode('svc:'+svcName, svcName, 'service');
      links.push({source: 'target:'+data.target, target: 'svc:'+svcName});
      const cve = s['v.cve_id']||s.cve_id;
      if (cve) {
        addNode('vuln:'+cve, cve, 'vulnerability');
        links.push({source: 'svc:'+svcName, target: 'vuln:'+cve});
      }
      const exploit = s['e.source_url']||s.source_url;
      if (exploit) {
        const eid = 'exploit:'+(cve||Math.random());
        addNode(eid, 'Exploit', 'exploit');
        links.push({source: 'vuln:'+cve, target: eid});
      }
    });

    (data.technology_risks || []).forEach(t => {
      const name = (t['tech.name']||t.name||'?')+' '+(t['tech.version']||t.version||'');
      addNode('tech:'+name, name.trim(), 'technology');
      links.push({source: 'target:'+data.target, target: 'tech:'+name});
    });
  }

  if (nodes.length <= 1) {
    svg.append('text').attr('x',width/2).attr('y',height/2).attr('text-anchor','middle')
      .attr('fill','#7c7f94').attr('font-size','14px').text('No graph data for this target');
    return;
  }

  const colors = {target:'#3b82f6',service:'#22c55e',vulnerability:'#ef4444',finding:'#f97316',technique:'#a855f7',exploit:'#f97316',technology:'#a855f7'};

  const simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d=>d.id).distance(100))
    .force('charge', d3.forceManyBody().strength(-250))
    .force('center', d3.forceCenter(width/2, height/2))
    .force('collision', d3.forceCollide().radius(35));

  const g = svg.append('g');

  // Zoom
  svg.call(d3.zoom().scaleExtent([0.3,5]).on('zoom', e => g.attr('transform', e.transform)));

  const link = g.append('g').selectAll('line').data(links).join('line')
    .attr('stroke','#2a2d3e').attr('stroke-width',1.5).attr('stroke-opacity',0.6);

  const node = g.append('g').selectAll('g').data(nodes).join('g')
    .call(d3.drag().on('start',(e,d)=>{if(!e.active)simulation.alphaTarget(0.3).restart();d.fx=d.x;d.fy=d.y;})
      .on('drag',(e,d)=>{d.fx=e.x;d.fy=e.y;})
      .on('end',(e,d)=>{if(!e.active)simulation.alphaTarget(0);d.fx=null;d.fy=null;}));

  node.append('circle').attr('r',d=>d.type==='target'?16:10)
    .attr('fill',d=>colors[d.type]||'#6366f1').attr('stroke','#1c1f2e').attr('stroke-width',2);

  node.append('text').text(d=>(d.label||'').substring(0,30)).attr('x',14).attr('y',4)
    .attr('font-size','11px').attr('fill','#e4e4eb').attr('font-family','Inter,sans-serif');

  // Tooltip
  node.append('title').text(d=>d.type+': '+d.label);

  simulation.on('tick', () => {
    link.attr('x1',d=>d.source.x).attr('y1',d=>d.source.y).attr('x2',d=>d.target.x).attr('y2',d=>d.target.y);
    node.attr('transform',d=>'translate('+d.x+','+d.y+')');
  });
}

// ── Init ──────────────────────────────────────────────────────────────────────

async function loadDashboard() {
  await Promise.all([loadStats(), loadSessions(), loadFindings()]);
}

document.getElementById('btn-refresh').addEventListener('click', loadDashboard);
document.getElementById('btn-close-detail').addEventListener('click', closeDetail);
document.getElementById('btn-refresh-missions').addEventListener('click', loadMissions);
document.getElementById('btn-close-mission').addEventListener('click', closeMissionDetail);
document.getElementById('btn-refresh-runs').addEventListener('click', loadInfraStats);
document.getElementById('btn-refresh-tools').addEventListener('click', loadInfraStats);
document.getElementById('btn-refresh-findings').addEventListener('click', loadDBFindings);
document.getElementById('findings-filter-status').addEventListener('change', loadDBFindings);
document.getElementById('btn-load-graph').addEventListener('click', loadGraphData);

setInterval(() => {
    const activeTab = document.querySelector('.tab-btn.active')?.dataset.tab;
    switch (activeTab) {
        case 'ctf': loadStats(); loadSessions(); loadFindings(); break;
        case 'bounty': loadMissions(); break;
        case 'infra': loadInfraStats(); break;
        case 'findings': loadDBFindings(); break;
        case 'graph': /* no auto-refresh for graph */ break;
    }
}, 30000);
loadDashboard();
connectWebSocket();
</script>
</body>
</html>
